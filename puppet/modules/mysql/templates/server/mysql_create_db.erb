#!/bin/bash

PATH=/bin:/usr/bin:/sbin:/usr/sbin

# Collect our arguments: database name, default character set (optional), and
# default collation (optional)
database=$1
charset=$2
collate=$3

# Do not save any of the subsequent commands in our MySQL history
MYSQL_HISTFILE=/dev/null
export MYSQL_HISTFILE

# Create database
mysqladmin create "$database" || exit 1

# Generate a strong, random password for the user
password=$(head -c 18 /dev/random | base64) || exit 2

# Create eponymous user with all privileges on the database
mysql <<EOF || exit 3
GRANT ALL ON $database.* TO '$database'@'localhost' IDENTIFIED BY '$password';
FLUSH PRIVILEGES;
EOF

# Save the account password in our private directory. (Using this 'tr' idiom
# rather than 'echo -n' keeps $password from appearing in the process list.)
cd <%= privatedir %> && umask 077 && tr -d "\n" >"$database" <<EOF || exit 4
$password
EOF

# Set default character set, if requested
if [ -n "$charset" ]; then
  mysql <<EOF || exit 5
    ALTER DATABASE $database DEFAULT CHARACTER SET '$charset';
EOF
fi

# Set default collation, if requested
if [ -n "$collate" ]; then
  mysql <<EOF || exit 6
    ALTER DATABASE $database DEFAULT COLLATE '$collate';
EOF
fi

exit 0
